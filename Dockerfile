FROM ubuntu:16.04

ENV CANTALOUPE_UID=999 \
    CANTALOUPE_GID=999 \
    JAVA_OPTS=-Xmx500m \
    PROPERTIES_FILE=/cantaloupe/cantaloupe.properties \
    HTTP_HTTP2_ENABLED="false" \
    HTTP_ACCEPT_QUEUE_LIMIT="" \
    BASE_URI="" \
    SLASH_SUBSTITUTE="" \
    MAX_PIXELS="400000000" \
    PRINT_STACK_TRACE_ON_ERROR_PAGES="true" \
    DELEGATE_SCRIPT_ENABLED="false" \
    DELEGATE_SCRIPT_PATHNAME="delegates.rb" \
    DELEGATE_SCRIPT_CACHE_ENABLED="false" \
    ENDPOINT_PUBLIC_AUTH_BASIC_ENABLED="false" \
    ENDPOINT_PUBLIC_AUTH_BASIC_USERNAME="myself" \
    ENDPOINT_PUBLIC_AUTH_BASIC_SECRET="mypassword" \
    ENDPOINT_IIIF_1_ENABLED="false" \
    ENDPOINT_IIIF_2_ENABLED="true" \
    ENDPOINT_IIIF_CONTENT_DISPOSITION="inline" \
    ENDPOINT_IIIF_MIN_SIZE="64" \
    ENDPOINT_IIIF_MIN_TILE_SIZE="512" \
    ENDPOINT_IIIF_2_RESTRICT_TO_SIZES="false" \
    ENDPOINT_ADMIN_ENABLED="false" \
    ENDPOINT_ADMIN_USERNAME="admin" \
    ENDPOINT_ADMIN_SECRET="" \
    ENDPOINT_API_ENABLED="false" \
    ENDPOINT_API_USERNAME="" \
    ENDPOINT_API_SECRET="" \
    SOURCE_STATIC="FilesystemSource" \
    SOURCE_DELEGATE="false" \
    FILESYSTEMSOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    FILESYSTEMSOURCE_BASICLOOKUPSTRATEGY_PATH_PREFIX="/home/myself/images/" \
    FILESYSTEMSOURCE_BASICLOOKUPSTRATEGY_PATH_SUFFIX="" \
    HTTPSOURCE_TRUST_ALL_CERTS="false" \
    HTTPSOURCE_REQUEST_TIMEOUT="" \
    HTTPSOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    HTTPSOURCE_BASICLOOKUPSTRATEGY_URL_PREFIX="http://localhost/images/" \
    HTTPSOURCE_BASICLOOKUPSTRATEGY_URL_SUFFIX="" \
    HTTPSOURCE_BASICLOOKUPSTRATEGY_AUTH_BASIC_USERNAME="" \
    HTTPSOURCE_BASICLOOKUPSTRATEGY_AUTH_BASIC_SECRET="" \
    JDBCSOURCE_URL="jdbc:postgresql://localhost:5432/my_database" \
    JDBCSOURCE_USER="postgres" \
    JDBCSOURCE_PASSWORD="postgres" \
    JDBCSOURCE_CONNECTION_TIMEOUT="10" \
    S3SOURCE_ENDPOINT="" \
    S3SOURCE_ACCESS_KEY_ID="" \
    S3SOURCE_SECRET_KEY="" \
    S3SOURCE_MAX_CONNECTIONS="" \
    S3SOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    S3SOURCE_BASICLOOKUPSTRATEGY_BUCKET_NAME="" \
    S3SOURCE_BASICLOOKUPSTRATEGY_PATH_PREFIX="" \
    S3SOURCE_BASICLOOKUPSTRATEGY_PATH_SUFFIX="" \
    AZURESTORAGESOURCE_ACCOUNT_NAME="" \
    AZURESTORAGESOURCE_ACCOUNT_KEY="" \
    AZURESTORAGESOURCE_CONTAINER_NAME="" \
    AZURESTORAGESOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    PROCESSOR_AVI="FfmpegProcessor" \
    PROCESSOR_BMP="" \
    PROCESSOR_DCM="ImageMagickProcessor" \
    PROCESSOR_FLV="FfmpegProcessor" \
    PROCESSOR_GIF="" \
    PROCESSOR_JP2="KakaduNativeProcessor" \
    PROCESSOR_JPG="" \
    PROCESSOR_MOV="FfmpegProcessor" \
    PROCESSOR_MP4="FfmpegProcessor" \
    PROCESSOR_MPG="FfmpegProcessor" \
    PROCESSOR_PDF="PdfBoxProcessor" \
    PROCESSOR_PNG="" \
    PROCESSOR_TIF="" \
    PROCESSOR_WEBM="FfmpegProcessor" \
    PROCESSOR_WEBP="ImageMagickProcessor" \
    PROCESSOR_FALLBACK="Java2dProcessor" \
    PROCESSOR_STREAM_RETRIEVAL_STRATEGY="StreamStrategy" \
    PROCESSOR_FALLBACK_RETRIEVAL_STRATEGY="DownloadStrategy" \
    PROCESSOR_DPI="150" \
    PROCESSOR_NORMALIZE="false" \
    PROCESSOR_BACKGROUND_COLOR="white" \
    PROCESSOR_DOWNSCALE_FILTER="bicubic" \
    PROCESSOR_UPSCALE_FILTER="bicubic" \
    PROCESSOR_SHARPEN="0" \
    PROCESSOR_METADATA_PRESERVE="false" \
    PROCESSOR_METADATA_RESPECT_ORIENTATION="false" \
    PROCESSOR_JPG_PROGRESSIVE="true" \
    PROCESSOR_JPG_QUALITY="80" \
    PROCESSOR_TIF_COMPRESSION="LZW" \
    PROCESSOR_IMAGEIO_BMP_READER="" \
    PROCESSOR_IMAGEIO_GIF_READER="" \
    PROCESSOR_IMAGEIO_GIF_WRITER="" \
    PROCESSOR_IMAGEIO_JPG_READER="" \
    PROCESSOR_IMAGEIO_JPG_WRITER="" \
    PROCESSOR_IMAGEIO_PNG_READER="" \
    PROCESSOR_IMAGEIO_PNG_WRITER="" \
    PROCESSOR_IMAGEIO_TIF_READER="" \
    PROCESSOR_IMAGEIO_TIF_WRITER="" \
    CACHE_CLIENT_ENABLED="true" \
    CACHE_CLIENT_MAX_AGE="2592000" \
    CACHE_CLIENT_SHARED_MAX_AGE="" \
    CACHE_CLIENT_PUBLIC="true" \
    CACHE_CLIENT_PRIVATE="false" \
    CACHE_CLIENT_NO_CACHE="false" \
    CACHE_CLIENT_NO_STORE="false" \
    CACHE_CLIENT_MUST_REVALIDATE="false" \
    CACHE_CLIENT_PROXY_REVALIDATE="false" \
    CACHE_CLIENT_NO_TRANSFORM="true" \
    CACHE_SERVER_SOURCE="FilesystemCache" \
    CACHE_SERVER_SOURCE_TTL_SECONDS="2592000" \
    CACHE_SERVER_DERIVATIVE_ENABLED="false" \
    CACHE_SERVER_DERIVATIVE="" \
    CACHE_SERVER_DERIVATIVE_TTL_SECONDS="2592000" \
    CACHE_SERVER_INFO_ENABLED="true" \
    CACHE_SERVER_PURGE_MISSING="false" \
    CACHE_SERVER_RESOLVE_FIRST="false" \
    CACHE_SERVER_WORKER_ENABLED="false" \
    CACHE_SERVER_WORKER_INTERVAL="86400" \
    FILESYSTEMCACHE_PATHNAME="/var/cache/cantaloupe" \
    FILESYSTEMCACHE_DIR_DEPTH="3" \
    FILESYSTEMCACHE_DIR_NAME_LENGTH="2" \
    HEAPCACHE_TARGET_SIZE="2G" \
    HEAPCACHE_PERSIST="false" \
    HEAPCACHE_PERSIST_FILESYSTEM_PATHNAME="/var/cache/cantaloupe/heap.cache" \
    JDBCCACHE_URL="jdbc:postgresql://localhost:5432/cantaloupe" \
    JDBCCACHE_USER="postgres" \
    JDBCCACHE_PASSWORD="" \
    JDBCCACHE_CONNECTION_TIMEOUT="10" \
    JDBCCACHE_DERIVATIVE_IMAGE_TABLE="derivative_cache" \
    JDBCCACHE_INFO_TABLE="info_cache" \
    S3CACHE_ENDPOINT="" \
    S3CACHE_ACCESS_KEY_ID="" \
    S3CACHE_SECRET_KEY="" \
    S3CACHE_BUCKET_NAME="" \
    S3CACHE_OBJECT_KEY_PREFIX="" \
    S3CACHE_MAX_CONNECTIONS="" \
    AZURESTORAGECACHE_ACCOUNT_NAME="" \
    AZURESTORAGECACHE_ACCOUNT_KEY="" \
    AZURESTORAGECACHE_CONTAINER_NAME="" \
    AZURESTORAGECACHE_OBJECT_KEY_PREFIX="" \
    REDISCACHE_HOST="localhost" \
    REDISCACHE_PORT="6379" \
    REDISCACHE_SSL="false" \
    REDISCACHE_PASSWORD="" \
    REDISCACHE_DATABASE="0" \
    OVERLAYS_ENABLED="false" \
    OVERLAYS_STRATEGY="BasicStrategy" \
    OVERLAYS_BASICSTRATEGY_TYPE="image" \
    OVERLAYS_BASICSTRATEGY_IMAGE="/path/to/overlay.png" \
    OVERLAYS_BASICSTRATEGY_STRING="Copyright \u00A9Ô∏è My Great Organization\nAll rights reserved." \
    OVERLAYS_BASICSTRATEGY_STRING_FONT="Helvetica" \
    OVERLAYS_BASICSTRATEGY_STRING_FONT_SIZE="24" \
    OVERLAYS_BASICSTRATEGY_STRING_FONT_MIN_SIZE="18" \
    OVERLAYS_BASICSTRATEGY_STRING_FONT_WEIGHT="1.0" \
    OVERLAYS_BASICSTRATEGY_STRING_GLYPH_SPACING="0.02" \
    OVERLAYS_BASICSTRATEGY_STRING_COLOR="white" \
    OVERLAYS_BASICSTRATEGY_STRING_STROKE_COLOR="black" \
    OVERLAYS_BASICSTRATEGY_STRING_STROKE_WIDTH="1" \
    OVERLAYS_BASICSTRATEGY_STRING_BACKGROUND_COLOR="rgba(0, 0, 0, 100)" \
    OVERLAYS_BASICSTRATEGY_POSITION="bottom right" \
    OVERLAYS_BASICSTRATEGY_INSET="10" \
    OVERLAYS_BASICSTRATEGY_OUTPUT_WIDTH_THRESHOLD="400" \
    OVERLAYS_BASICSTRATEGY_OUTPUT_HEIGHT_THRESHOLD="300" \
    REDACTION_ENABLED="false" \
    LOG_APPLICATION_LEVEL="debug" \
    LOG_APPLICATION_CONSOLEAPPENDER_ENABLED="true" \
    LOG_APPLICATION_FILEAPPENDER_ENABLED="false" \
    LOG_APPLICATION_FILEAPPENDER_PATHNAME="/path/to/logs/application.log" \
    LOG_APPLICATION_ROLLINGFILEAPPENDER_ENABLED="false" \
    LOG_APPLICATION_ROLLINGFILEAPPENDER_PATHNAME="/path/to/logs/application.log" \
    LOG_APPLICATION_ROLLINGFILEAPPENDER_POLICY="TimeBasedRollingPolicy" \
    LOG_APPLICATION_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_FILENAME_PATTERN="/path/to/logs/application-%d{yyyy-MM-dd}.log" \
    LOG_APPLICATION_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_MAX_HISTORY="30" \
    LOG_APPLICATION_SYSLOGAPPENDER_ENABLED="false" \
    LOG_APPLICATION_SYSLOGAPPENDER_HOST="" \
    LOG_APPLICATION_SYSLOGAPPENDER_PORT="514" \
    LOG_APPLICATION_SYSLOGAPPENDER_FACILITY="LOCAL0" \
    LOG_ERROR_FILEAPPENDER_ENABLED="false" \
    LOG_ERROR_FILEAPPENDER_PATHNAME="/path/to/logs/error.log" \
    LOG_ERROR_ROLLINGFILEAPPENDER_ENABLED="false" \
    LOG_ERROR_ROLLINGFILEAPPENDER_PATHNAME="/path/to/logs/error.log" \
    LOG_ERROR_ROLLINGFILEAPPENDER_POLICY="TimeBasedRollingPolicy" \
    LOG_ERROR_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_FILENAME_PATTERN="/path/to/logs/error-%d{yyyy-MM-dd}.log" \
    LOG_ERROR_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_MAX_HISTORY="30" \
    LOG_ACCESS_CONSOLEAPPENDER_ENABLED="false" \
    LOG_ACCESS_FILEAPPENDER_ENABLED="false" \
    LOG_ACCESS_FILEAPPENDER_PATHNAME="/path/to/logs/access.log" \
    LOG_ACCESS_ROLLINGFILEAPPENDER_ENABLED="false" \
    LOG_ACCESS_ROLLINGFILEAPPENDER_PATHNAME="/path/to/logs/access.log" \
    LOG_ACCESS_ROLLINGFILEAPPENDER_POLICY="TimeBasedRollingPolicy" \
    LOG_ACCESS_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_FILENAME_PATTERN="/path/to/logs/access-%d{yyyy-MM-dd}.log" \
    LOG_ACCESS_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_MAX_HISTORY="30" \
    LOG_ACCESS_SYSLOGAPPENDER_ENABLED="false" \
    LOG_ACCESS_SYSLOGAPPENDER_HOST="" \
    LOG_ACCESS_SYSLOGAPPENDER_PORT="514" \
    LOG_ACCESS_SYSLOGAPPENDER_FACILITY="LOCAL0"

COPY . /build
RUN /build/setup.sh

EXPOSE 8182
WORKDIR /cantaloupe
HEALTHCHECK CMD curl --fail http://localhost:8182/ || exit 1
CMD ["/build/entrypoint.sh"]
